<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Bootstrap core CSS -->
    <link th:href="@{/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/simple-sidebar.css}" rel="stylesheet">
    <!-- Include jQuery 모달-->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <!-- Include Popper.js for Bootstrap tooltips and popovers 모달-->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <!-- Include Bootstrap JS 모달-->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <title>마이페이지</title>
    <style type="text/css">
        body {
            margin-top: 20px;
            color: #1a202c;
            text-align: center;
            background-color: #2c3e50;
            background-image: url('../images/창구.png'); /* 여기에 배경 이미지 경로를 입력하세요 */
            background-size: cover; /* 배경 이미지가 요소 전체를 덮도록 */
            background-position: center; /* 배경 이미지의 중심을 맞추기 */
            background-repeat: no-repeat; /* 배경 이미지 반복 방지 */
        }

        .form_field2 {
            margin: 10px 0;
        }

        .form_field2 > input {
            text-align: left;
            padding: 15px 5px;
            width: 100%;
            max-width: 400px; /* 최대 너비 설정 */
            height: 40px;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            color: #495057;
        }

        .main-body {
            padding: 15px;
        }

        .card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);
        }

        .custom-card {
            max-width: 700px; /* 최대 너비 설정 */
            margin: auto; /* 가운데 정렬 */
        }

        .card-body {
            flex: 1 1 auto;
            min-height: 1px;
            padding: 1rem;
        }

        .gutters-sm {
            margin-right: -8px;
            margin-left: -8px;
        }

        .gutters-sm>.col, .gutters-sm>[class*=col-] {
            padding-right: 8px;
            padding-left: 8px;
        }

        .mb-3, .my-3 {
            margin-bottom: 1rem !important;
        }

        .bg-gray-300 {
            background-color: #e2e8f0;
        }

        .h-100 {
            height: 100% !important;
        }

        .shadow-none {
            box-shadow: none !important;
        }

        .left-aligned-container {
            margin: 0;
            padding: 0;
            width: auto;
        }

        .text-black {
            color: black;
        }

        .btn-primary2

        {
            margin-top: 20px; /* 버튼 위쪽 마진 설정 */
        }

        .form-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #MatchMessage {
            margin-left: 10px; /* 버튼과 메시지 간의 간격 */
        }

        .info-box {
            display: flex; /* Flexbox 레이아웃 사용 */
            flex-direction: column; /* 세로 방향으로 배치 */
            align-items: center; /* 가로 방향 중앙 정렬 */
            background-color: #f8f9fa; /* 박스의 배경색 */
            border: 3px solid #dee2e6; /* 박스의 테두리 색 */
            border-radius: 0.25rem; /* 테두리의 둥근 정도 */
            padding: 15px; /* 내부 여백 */
            margin-bottom: 15px; /* 하단 여백 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* 박스의 그림자 */
        }

        .info-box h4 {
            margin-bottom: 10px; /* 제목과 아이디 간의 여백 */
        }

        .info-box p {
            margin: 0; /* 아이디의 상하 여백 제거 */
        }

        .checkbox-container {
            display: flex; /* Flexbox 레이아웃 사용 */
            align-items: center; /* 체크박스와 텍스트를 수직 중앙 정렬 */
            cursor: pointer; /* 커서 모양을 포인터로 설정 */
        }

        .checkbox-container input[type="checkbox"] {
            transform: scale(1.5); /* 체크박스 크기 조정 */
            margin-right: 8px; /* 체크박스와 텍스트 간격 조정 */
        }

        /* 체크박스와 텍스트의 영역을 클릭 가능한 범위로 설정 */
        .checkbox-container label {
            margin: 0; /* 레이블의 상하 여백 제거 */
            font-size: 14px; /* 레이블 텍스트 크기 조정 */
            color: #000; /* 레이블 텍스트 색상 */
        }

        /* 체크박스의 부모 label 요소가 클릭 가능하도록 설정 */
        .checkbox-container input[type="checkbox"] + span {
            display: block;
        }

        .text-color {
            color: #333; /* 검은색으로 설정 */
        }


    </style>
</head>

<body>
<!-- 모달 -->
<div class="modal fade" id="updateSuccess" tabindex="-1" role="dialog" aria-labelledby="updateSuccessLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateSuccessLabel">회원 정보가 수정됐습니다</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" th:text="${updateSuccess}"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<th:block th:replace="~{/layout/basic :: setContent(~{this::content})}">
    <th:block th:fragment="content">
        <div class="left-aligned-container">
            <div class="main-body">
                <div class="row gutters-sm">
                    <div class="col-md-8 mx-auto mb-3">
                        <div class="card custom-card">
                            <div class="card-body">
                                <form id="updateProfileForm" th:action="@{/Member/updateProfile}" method="post" onsubmit="return validateForm()">
                                    <div class="info-box">
                                        <h4 class="text-center mb-4 text-black">회원 정보 수정</h4>
                                        <p class="form_field2 text-black" id="Correction_id" th:text="'아이디: ' + ${loggedInUser.username}"></p>
                                    </div>
                                    <div class="form_field2">
                                        <input type="hidden" placeholder="New ID" id="newuser_id" name="newuser_id" th:value="${loggedInUser.username}" />
                                    </div>

                                    <!-- 닉네임 필드 -->
                                    <p class="form_field2 text-black" id="Correction_nickname" th:text="'닉네임: ' + ${loggedInUser.nickname}"></p>
                                    <div class="form_field2">
                                        <input type="text" placeholder="New Nickname" id="newuser_nick" name="newuser_nick" th:value="${loggedInUser.nickname}" />
                                    </div>

                                    <!-- 이메일 필드 -->
                                    <p class="form_field2 text-black" id="Correction_email" th:text="'이메일: ' + ${loggedInUser.email}"></p>
                                    <div class="form_field2">
                                        <input type="email" placeholder="New Email" id="newuser_email" name="newuser_email" th:value="${loggedInUser.email}" />
                                    </div>

                                    <!-- 비밀번호 변경 체크박스 -->
                                    <div class="form_field2">
                                        <label class="checkbox-container text-color ">
                                            <input type="checkbox" id="changePasswordCheckbox" onclick="togglePasswordFields()">
                                            <span class="checkbox-label text-color">비밀번호 변경</span>
                                        </label>
                                    </div>

                                    <!-- 비밀번호 필드 -->
                                    <div id="passwordFields" style="display: none;">
                                        <p class="form_field2 text-black" id="Correction_pass">비밀번호를 변경하시려면 새로운 비밀번호를 입력하여 주십시오</p>
                                        <div class="form_field2">
                                            <input type="password" placeholder="New Password" id="newuser_password" name="newuser_password" onkeyup="checkPasswordMatch();" />
                                        </div>
                                        <div class="form_field2">
                                            <input type="password" placeholder="Confirm Password" id="newuser_password2" name="newuser_password2" onkeyup="checkPasswordMatch();" />
                                        </div>
                                    </div>

                                    <!-- 버튼 및 메시지 -->
                                    <div class="form-footer">
                                        <button class="btn btn-primary2 btn-primary" type="submit">수정하기</button>
                                        <div id="MatchMessage"></div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </th:block>
</th:block>
<script>
    function validateForm() {
        var form = document.getElementById('updateProfileForm');
        var newUserId = form.querySelector('#newuser_id').value.trim();
        var newUserNick = form.querySelector('#newuser_nick').value.trim();
        var newUserEmail = form.querySelector('#newuser_email').value.trim();
        var newUserPassword = form.querySelector('#newuser_password').value.trim();
        var newUserPassword2 = form.querySelector('#newuser_password2').value.trim();
        var message = document.getElementById("MatchMessage");

        // 정규 표현식
        var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        var pattern = /^[가-힣a-zA-Z]+$/;

        // 필드가 비어있는 경우, 수정하지 않기로 선택한 경우
        if (!newUserId && !newUserNick && !newUserEmail && !newUserPassword) {
            message.innerHTML = "수정을 위해서 정보를 입력해주세요";
            message.style.color = "red";
            return false;
        }

        // 이메일 형식 검증
        if (newUserEmail && !emailPattern.test(newUserEmail)) {
            message.innerHTML = "이메일 형식이 맞지 않습니다";
            message.style.color = "red";
            return false;
        }

        if (!pattern.test(newUserNick)) {
            message.innerHTML = "닉네임은 한글과 영문 또는 한글과 영문 혼합만 가능합니다.";
            message.style.color = "red";
            return false;
        }

        if(newUserId.length < 6){
            message.innerHTML = "ID 는 6글자 이상이어야합니다.";
            message.style.color = "red";
            return false;
        }
    if (newUserPassword || newUserPassword2) {
        if (newUserPassword !== newUserPassword2) {
            message.innerHTML = "비밀번호가 일치하지 않습니다";
            message.style.color = "red";
            return false;
        }

        if (newUserPassword.length < 6) {
            message.innerHTML = "비밀번호는 6글자 이상이어야 합니다";
            message.style.color = "red";
            return false;
        }
    }

        // 입력이 유효한 경우 폼 제출 허용
        return true;
    }

    function checkPasswordMatch() {
        var newUserPassword = document.getElementById('newuser_password').value.trim();
        var newUserPassword2 = document.getElementById('newuser_password2').value.trim();
        var message = document.getElementById("MatchMessage");

        if(newUserPassword == null && newUserPassword2 == null){
               message.innerHTML = "";
        }else{
            if (newUserPassword.length < 6) {
                message.innerHTML = "비밀번호는 6글자 이상이어야 합니다.";
                message.style.color = "red";
            } else if (newUserPassword === newUserPassword2) {
                message.innerHTML = "비밀번호가 일치합니다.";
                message.style.color = "green";
            } else {
                message.innerHTML = "비밀번호가 일치하지 않습니다.";
                message.style.color = "red";
            }
        }
    }
</script>
<script>
    function togglePasswordFields() {
    var checkbox = document.getElementById('changePasswordCheckbox');
    var passwordFields = document.getElementById('passwordFields');
    if (checkbox.checked) {
        passwordFields.style.display = 'block';
    } else {
        passwordFields.style.display = 'none';
    }
}

</script>
<!-- 모달 스크립트 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        var updateSuccess = /*[[${updateSuccess}]]*/ '';
        var updateError = /*[[${updateError}]]*/ '';

        if (updateSuccess) {
            $('#updateSuccess').modal('show');
        }
        if (updateError) {
            $('#updateError').modal('show');
            change_to_login();
        }
    });
    /*]]>*/
</script>
</body>
</html>
